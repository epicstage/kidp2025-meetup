<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>테이블 조회 - EpicStage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/common-styles.css">
    <!-- Fuse.js for search -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>
    <style>
        body {
            background: #FFFFFF;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Fallback JSON 배너 -->
    <div id="fallbackBanner" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
            </div>
            <div class="ml-3">
                <p class="text-sm text-yellow-700">
                    <strong>Fallback 모드:</strong> 현재 Fallback JSON을 사용하여 조회 중입니다.
                </p>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- 현재 이벤트 표시 -->
        <div class="modular-card p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">현재 이벤트</label>
                    <p id="currentEventName" class="text-lg font-semibold text-gray-900">로딩 중...</p>
                </div>
                <button 
                    id="refreshEventBtn" 
                    class="btn-secondary"
                >
                    새로고침
                </button>
            </div>
        </div>

        <!-- 검색 섹션 -->
        <div id="searchSection" class="hidden modular-card p-6 mb-6">
            <h2 class="text-2xl font-black text-black mb-4">이름/회사명 검색</h2>
            <div class="relative">
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="이름 또는 회사명을 입력하세요..." 
                    class="input-field w-full pr-12"
                >
                <button 
                    id="searchBtn" 
                    class="btn-primary absolute right-2 top-2"
                >
                    검색
                </button>
            </div>
        </div>

        <!-- 검색 결과 -->
        <div id="resultsSection" class="hidden">
            <div id="loading" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                <p class="mt-4 text-gray-600">검색 중...</p>
            </div>

            <div id="error" class="hidden bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg mb-4">
                <p id="errorMessage"></p>
            </div>

            <div id="results" class="space-y-4">
                <!-- 동적으로 생성됨 -->
            </div>
        </div>

        <!-- 검색 결과 없음 -->
        <div id="noResults" class="hidden text-center py-12">
            <p class="text-gray-500 text-lg">검색 결과가 없습니다.</p>
            <p class="text-gray-400 text-sm mt-2">이름 또는 회사명을 확인해주세요.</p>
        </div>
    </div>

    <script>
        let eventId = null;
        let fallbackData = null;
        let useFallback = false;

        // 단일 이벤트 로드 (이벤트 ID 1 고정)
        async function loadLatestEvent() {
            // 단일 행사만 지원하므로 이벤트 ID를 1로 고정
            eventId = 1;
            
            try {
                // 이벤트 정보 가져오기
                const response = await fetch(`/api/admin/events/${eventId}`);
                const data = await response.json();
                
                if (response.ok && data.event) {
                    document.getElementById('currentEventName').textContent = data.event.name || `이벤트 #${eventId}`;
                } else {
                    document.getElementById('currentEventName').textContent = `이벤트 #${eventId}`;
                }
                
                document.getElementById('searchSection').classList.remove('hidden');
                
                // Fallback JSON 로드 시도
                await loadFallbackJSON();
            } catch (error) {
                console.error('이벤트 정보 로드 오류:', error);
                // 오류가 있어도 이벤트 ID는 1로 고정하여 계속 진행
                document.getElementById('currentEventName').textContent = `이벤트 #${eventId}`;
                document.getElementById('searchSection').classList.remove('hidden');
            }
        }

        // 새로고침 버튼
        document.getElementById('refreshEventBtn').addEventListener('click', async () => {
            await loadLatestEvent();
        });

        // 페이지 로드 시 자동으로 최근 이벤트 로드
        loadLatestEvent();

        // Fallback JSON 로드
        async function loadFallbackJSON() {
            try {
                const response = await fetch(`/static/matching_results_${eventId}.json`);
                if (response.ok) {
                    fallbackData = await response.json();
                    useFallback = true;
                    document.getElementById('fallbackBanner').classList.remove('hidden');
                } else {
                    useFallback = false;
                    document.getElementById('fallbackBanner').classList.add('hidden');
                }
            } catch (error) {
                console.log('Fallback JSON 로드 실패, DB 조회 사용');
                useFallback = false;
                document.getElementById('fallbackBanner').classList.add('hidden');
            }
        }

        // 검색 버튼
        document.getElementById('searchBtn').addEventListener('click', () => {
            performSearch();
        });

        // Enter 키로 검색
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // 검색 수행
        async function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                alert('검색어를 입력하세요.');
                return;
            }

            if (!eventId) {
                alert('이벤트를 먼저 선택하세요.');
                return;
            }

            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('error').classList.add('hidden');
            document.getElementById('results').innerHTML = '';
            document.getElementById('noResults').classList.add('hidden');

            try {
                let results = [];

                if (useFallback && fallbackData) {
                    // Fallback JSON에서 검색 (Fuse.js 사용)
                    const fuse = new Fuse(fallbackData.matches || [], {
                        keys: ['participant_name', 'participant_company', 'target_name', 'target_company'],
                        threshold: 0.3,
                        includeScore: true
                    });

                    const searchResults = fuse.search(query);
                    const matchedParticipants = new Set();
                    const resultsMap = new Map();

                    searchResults.forEach(result => {
                        const match = result.item;
                        const participantId = match.participant_id;
                        const targetId = match.target_id;

                        // 참가자 기준으로 그룹화
                        if (!resultsMap.has(participantId)) {
                            resultsMap.set(participantId, {
                                participant_id: participantId,
                                participant_name: match.participant_name,
                                participant_company: match.participant_company,
                                participant_group: match.participant_group || 'A',
                                matches: [],
                            });
                        }

                        // 중복 제거
                        const existing = resultsMap.get(participantId).matches.find(
                            m => m.target_id === targetId
                        );
                        if (!existing) {
                            resultsMap.get(participantId).matches.push({
                                target_id: targetId,
                                target_name: match.target_name,
                                target_company: match.target_company,
                                target_group: match.target_group || 'A',
                                score: match.score,
                            });
                        }
                    });

                    results = Array.from(resultsMap.values());
                } else {
                    // DB에서 검색
                    const response = await fetch(`/api/events/${eventId}/lookup?name=${encodeURIComponent(query)}`);
                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || '검색 실패');
                    }

                    results = data.results || [];
                }

                document.getElementById('loading').classList.add('hidden');

                if (results.length === 0) {
                    document.getElementById('noResults').classList.remove('hidden');
                    return;
                }

                renderResults(results);
            } catch (error) {
                console.error('검색 오류:', error);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error').classList.remove('hidden');
                document.getElementById('errorMessage').textContent = '검색 중 오류가 발생했습니다: ' + error.message;
            }
        }

        // 결과 렌더링
        function renderResults(results) {
            const container = document.getElementById('results');
            container.innerHTML = '';

            results.forEach(result => {
                const card = document.createElement('div');
                card.className = 'modular-card p-6 fade-in';
                card.innerHTML = `
                    <div class="mb-4">
                        <h3 class="text-xl font-bold text-gray-900">${result.participant_name}</h3>
                        <p class="text-gray-600">${result.participant_company}</p>
                        <p class="text-sm text-gray-500 mt-1">${result.participant_group}그룹</p>
                    </div>
                    
                    ${result.matches.length > 0 ? `
                        <div class="border-t border-gray-200 pt-4">
                            <h4 class="text-sm font-semibold text-gray-700 mb-3">매칭된 팀</h4>
                            <div class="space-y-2">
                                ${result.matches.map(match => `
                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                        <div>
                                            <p class="font-medium text-gray-900">${match.target_name}</p>
                                            <p class="text-sm text-gray-600">${match.target_company}</p>
                                            <p class="text-xs text-gray-500">${match.target_group}그룹</p>
                                        </div>
                                        <div class="text-right">
                                            <span class="text-sm font-semibold text-blue-600">점수: ${match.score}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : '<p class="text-gray-500 text-sm">매칭된 팀이 없습니다.</p>'}
                `;
                container.appendChild(card);
            });
        }
    </script>
</body>
</html>

