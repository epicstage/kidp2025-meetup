<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>ê¸°ìˆ ê¸°ì—… ëª©ë¡ - 2025 ë””ìì¸-ê¸°ìˆ  í˜‘ì—… ì „ì£¼ê¸°ì§€ì›</title>
  <style>
    * {margin: 0; padding: 0; box-sizing: border-box;}
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
      color: #ffffff;
      min-height: 100vh;
      padding: 20px;
    }
    
    .wrap {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    header {
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid #2a2a2a;
      padding-bottom: 12px;
      margin-bottom: 30px;
    }
    
    header .dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #DC2626;
    }
    
    h1 {
      font-size: 24px;
      margin: 0;
      font-weight: 700;
      color: #ffffff;
    }
    
    .back-btn {
      display: inline-block;
      padding: 10px 20px;
      background: #1a1a1a;
      border: 2px solid #2a2a2a;
      border-radius: 8px;
      color: #ffffff;
      text-decoration: none;
      margin-bottom: 20px;
      transition: all 0.2s;
      font-weight: 600;
    }
    
    .back-btn:hover {
      background: #DC2626;
      color: #FFFFFF;
      border-color: #DC2626;
    }
    
    .search-box {
      margin-bottom: 30px;
    }
    
    .search-input {
      width: 100%;
      padding: 16px 20px;
      border: 2px solid #2a2a2a;
      border-radius: 12px;
      background: #1a1a1a;
      color: #ffffff;
      font-size: 16px;
      box-sizing: border-box;
      transition: all 0.2s;
      -webkit-appearance: none;
      appearance: none;
    }
    
    .search-input:focus {
      outline: none;
      border-color: #DC2626;
      box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
    }
    
    .filter-section {
      margin-bottom: 25px;
    }
    
    .filter-label {
      color: #a0a0a0;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      display: block;
    }
    
    .filter-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .filter-btn {
      padding: 10px 18px;
      background: #1a1a1a;
      border: 2px solid #2a2a2a;
      border-radius: 8px;
      color: #ffffff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .filter-btn:hover {
      background: #2a2a2a;
      border-color: #DC2626;
    }
    
    .filter-btn.active {
      background: #DC2626;
      border-color: #DC2626;
      color: #ffffff;
    }
    
    .search-input::placeholder {
      color: #999999;
    }
    
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }
    
    .card {
      background: #1a1a1a;
      border: 2px solid #2a2a2a;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(220, 38, 38, 0.3);
      border-color: #DC2626;
    }
    
    .card h3 {
      color: #DC2626;
      margin-top: 0;
      margin-bottom: 12px;
      font-size: 20px;
      font-weight: 700;
      word-break: break-word;
      overflow-wrap: break-word;
    }
    
    .card-desc {
      color: #a0a0a0;
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 12px;
      word-break: break-word;
      white-space: pre-wrap;
      overflow-wrap: break-word;
    }
    
    .card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }
    
    .card-badge {
      padding: 6px 12px;
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 6px;
      font-size: 12px;
      color: #ffffff;
      font-weight: 600;
    }
    
    .muted {
      color: #a0a0a0;
      font-size: 14px;
      text-align: center;
      padding: 40px 20px;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      overflow: auto;
    }
    
    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: #1a1a1a;
      margin: 20px;
      padding: 30px;
      border-radius: 16px;
      max-width: 700px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      border: 2px solid #2a2a2a;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }
    
    .modal-content h2 {
      color: #DC2626;
      margin-top: 0;
      border-bottom: 1px solid #2a2a2a;
      padding-bottom: 12px;
      word-break: break-word;
      overflow-wrap: break-word;
      font-size: 24px;
    }
    
    .modal-close {
      float: right;
      font-size: 32px;
      font-weight: bold;
      color: #ffffff;
      cursor: pointer;
      line-height: 1;
      margin-top: -5px;
      transition: color 0.2s;
    }
    
    .modal-close:hover {
      color: #DC2626;
    }
    
    .modal-row {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #2a2a2a;
    }
    
    .modal-row:last-child {
      border-bottom: none;
    }
    
    .modal-label {
      color: #a0a0a0;
      font-size: 13px;
      margin-bottom: 6px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .modal-value {
      color: #ffffff;
      font-size: 15px;
      line-height: 1.6;
      word-break: break-word;
      white-space: pre-wrap;
      overflow-wrap: break-word;
    }
    
    /* ë°‹ì—… ì‹ ì²­ ìŠ¬ë¡¯ ì˜ì—­ */
    .meetup-slots {
      background: #1a1a1a;
      border: 2px solid #2a2a2a;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
    }

    .readonly-banner {
      margin: 20px 0;
      padding: 16px;
      background: rgba(220, 38, 38, 0.12);
      border: 1px solid #DC2626;
      border-radius: 8px;
      color: #ffffff;
      font-size: 14px;
      line-height: 1.6;
    }
    
    .meetup-slots h2 {
      color: #DC2626;
      font-size: 18px;
      margin: 0 0 15px 0;
      font-weight: 700;
    }
    
    .meetup-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      justify-content: flex-end;
    }
    
    .submit-btn, .reset-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .submit-btn {
      background: #DC2626;
      color: #ffffff;
    }
    
    .submit-btn:hover {
      background: #B91C1C;
    }
    
    .submit-btn:disabled {
      background: #666666;
      cursor: not-allowed;
      opacity: 0.5;
    }
    
    .reset-btn {
      background: #2a2a2a;
      color: #ffffff;
      border: 2px solid #2a2a2a;
    }
    
    .reset-btn:hover {
      background: #1a1a1a;
      border-color: #DC2626;
    }
    
    .slots-container {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 12px;
      padding: 10px;
    }
    
    .slot {
      background: #0a0a0a;
      border: 2px dashed #2a2a2a;
      border-radius: 8px;
      padding: 20px 15px;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    
    .slot:hover {
      border-color: #DC2626;
      background: #1a1a1a;
    }
    
    
    .slot.filled {
      border-style: solid;
      border-color: #DC2626;
      background: #1a1a1a;
    }
    
    .slot-number {
      color: #a0a0a0;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .slot-content {
      color: #ffffff;
      font-size: 13px;
      font-weight: 600;
      text-align: center;
      word-break: break-word;
      overflow-wrap: break-word;
      line-height: 1.4;
    }
    
    .slot-remove {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 20px;
      height: 20px;
      background: #DC2626;
      border: none;
      border-radius: 50%;
      color: #ffffff;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .slot.filled:hover .slot-remove {
      opacity: 1;
    }
    
    .slot-empty-text {
      color: #666666;
      font-size: 11px;
      text-align: center;
    }
    
    /* ì¹´ë“œ ì„ íƒ í‘œì‹œ */
    .card.selected {
      border-color: #DC2626;
      background: rgba(220, 38, 38, 0.05);
    }
    
    .card-selected-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #DC2626;
      color: #ffffff;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      box-shadow: 0 2px 8px rgba(220, 38, 38, 0.4);
    }
    
    .card {
      position: relative;
    }
    
    
    /* ë°‹ì—… ì‹ ì²­ ë²„íŠ¼ */
    .meetup-btn {
      position: absolute;
      bottom: 10px;
      right: 10px;
      padding: 6px 12px;
      background: #DC2626;
      border: none;
      border-radius: 6px;
      color: #ffffff;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      z-index: 10;
    }
    
    .meetup-btn:hover {
      background: #B91C1C;
      transform: scale(1.05);
    }
    
    .meetup-btn:active {
      transform: scale(0.95);
    }
    
    .meetup-btn.added {
      background: #10B981;
    }
    
    .meetup-btn.added:hover {
      background: #059669;
    }
    
    /* ëª¨ë‹¬ ë‚´ë¶€ ë²„íŠ¼ */
    .modal-meetup-btn {
      margin-top: 20px;
      padding: 12px 24px;
      background: #DC2626;
      border: none;
      border-radius: 8px;
      color: #ffffff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
    }
    
    .modal-meetup-btn:hover {
      background: #B91C1C;
    }
    
    .modal-meetup-btn:active {
      transform: scale(0.98);
    }
    
    .modal-meetup-btn.added {
      background: #10B981;
    }
    
    .modal-meetup-btn.added:hover {
      background: #059669;
    }
    
    @media (max-width: 768px) {
      body {
        padding: 15px;
      }
      
      .wrap {
        padding: 0;
      }
      
      header {
        padding-bottom: 10px;
        margin-bottom: 20px;
      }
      
      h1 {
        font-size: 20px;
      }
      
      .back-btn {
        padding: 8px 16px;
        font-size: 14px;
        margin-bottom: 15px;
      }
      
      .search-box {
        margin-bottom: 20px;
      }
      
      .search-input {
        padding: 14px 16px;
        font-size: 15px;
        border-width: 2px;
      }
      
      .grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .card {
        padding: 16px;
        border-width: 2px;
      }
      
      .card h3 {
        font-size: 18px;
        margin-bottom: 10px;
      }
      
      .card-desc {
        font-size: 13px;
        margin-bottom: 10px;
      }
      
      .card-badge {
        padding: 5px 10px;
        font-size: 11px;
      }
      
      .modal-content {
        margin: 10px;
        padding: 20px;
        width: calc(100% - 20px);
        max-height: 90vh;
        border-width: 2px;
      }
      
      .modal-content h2 {
        font-size: 20px;
        padding-bottom: 10px;
      }
      
      .modal-close {
        font-size: 28px;
      }
      
      .modal-row {
        margin-bottom: 16px;
        padding-bottom: 16px;
      }
      
      .modal-label {
        font-size: 12px;
        margin-bottom: 5px;
      }
      
      .modal-value {
        font-size: 14px;
      }
    }
    
    @media (max-width: 480px) {
      body {
        padding: 10px;
      }
      
      header {
        padding-bottom: 8px;
        margin-bottom: 15px;
      }
      
      header .dot {
        width: 10px;
        height: 10px;
      }
      
      h1 {
        font-size: 18px;
      }
      
      .back-btn {
        padding: 6px 12px;
        font-size: 13px;
        margin-bottom: 12px;
      }
      
      .search-input {
        padding: 12px 14px;
        font-size: 14px;
      }
      
      .grid {
        gap: 12px;
      }
      
      .card {
        padding: 14px;
      }
      
      .card h3 {
        font-size: 16px;
      }
      
      .card-desc {
        font-size: 12px;
      }
      
      .modal-content {
        margin: 5px;
        padding: 16px;
        width: calc(100% - 10px);
      }
      
      .modal-content h2 {
        font-size: 18px;
      }
      
      .modal-close {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <a href="index.html" class="back-btn">â† í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    <header>
      <div class="dot"></div>
      <h1>ê¸°ìˆ ê¸°ì—… ëª©ë¡</h1>
    </header>

    <!-- ë°‹ì—… ì‹ ì²­ ìŠ¬ë¡¯ ì˜ì—­ -->
    <div class="meetup-slots">
      <h2>ë°‹ì—… ì‹ ì²­ (ìµœëŒ€ 7ê°œ ì„ íƒ)</h2>
      <div class="slots-container" id="slotsContainer">
        <!-- ìŠ¬ë¡¯ì€ JavaScriptë¡œ ë™ì  ìƒì„± -->
      </div>
      <div class="meetup-actions">
        <button class="reset-btn" onclick="resetSelections()">ë‹¤ì‹œì„ íƒí•˜ê¸°</button>
        <button class="submit-btn" id="submitBtn" onclick="submitSelections()">ì œì¶œí•˜ê¸°</button>
      </div>
    </div>

    <div class="search-box">
      <input 
        type="text"
        id="searchInput"
        class="search-input"
        placeholder="ğŸ” íšŒì‚¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="none"
        spellcheck="false"
      />
    </div>

    <div class="filter-section">
      <span class="filter-label">ì£¼ìš” ì‚¬ì—… ë¶„ì•¼ í•„í„°:</span>
      <div id="filterButtons" class="filter-buttons">
        <button class="filter-btn active" data-filter="">ì „ì²´</button>
      </div>
    </div>

    <div id="results" class="grid"></div>
  </div>
  
  <!-- ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
  <div id="detailModal" class="modal">
    <div class="modal-content" id="modalContent">
    </div>
  </div>

  <script>
  const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTdxkwUoTKh5y5xLeMwerXez9IpL6_QEY09ipRULpS-R60XiiSVMWC3LEjgVzHU57_EjlIVvg1LfSw_/pub?output=csv';
  const DESIGN_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRH6aVLkutbRv8_gv9kSdHS62fmcYV6_sLBRjGoPQyHHahyWMBdEm7nLVLPlkrnGccKXB462N9ZgKyK/pub?output=csv';
  const READ_ONLY_EMAILS = ['bgtree456@kidp.or.kr', 'pd@epicstage.co.kr'];
  
  let rows = [];
  let headerMap = {};
  let searchKeyword = '';
  let selectedFilters = []; // ë³µìˆ˜ ì„ íƒì„ ìœ„í•œ ë°°ì—´
  let userEmail = ''; // ì¸ì¦ëœ ì‚¬ìš©ì ì´ë©”ì¼
  let selections = {}; // {priority: companyData} í˜•íƒœë¡œ ì €ì¥
  let isReadOnly = false;
  let readOnlyBannerAdded = false;
  
  // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // URL íŒŒë¼ë¯¸í„°ì—ì„œ ì´ë©”ì¼ ê°€ì ¸ì˜¤ê¸°
  function getEmailFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('email') || '';
  }

  function isReadOnlyEmail(email) {
    return READ_ONLY_EMAILS.includes((email || '').toLowerCase());
  }

  function enterReadOnlyMode() {
    if (readOnlyBannerAdded) return;
    const slots = document.querySelector('.meetup-slots');
    if (slots) {
      slots.style.display = 'none';
    }
    const banner = document.createElement('div');
    banner.className = 'readonly-banner';
    banner.textContent = 'ì´ ê³„ì •ì€ ëª©ë¡ ì¡°íšŒ ì „ìš©ì…ë‹ˆë‹¤. ê¸°ì—… ëª©ë¡ë§Œ í™•ì¸í•  ìˆ˜ ìˆìœ¼ë©° ë°‹ì—… ì‹ ì²­ ê¸°ëŠ¥ì€ ì œí•œë©ë‹ˆë‹¤.';
    const header = document.querySelector('header');
    if (header && header.parentNode) {
      header.parentNode.insertBefore(banner, header.nextSibling);
    }
    readOnlyBannerAdded = true;
  }
  
  // ì´ë©”ì¼ ì¸ì¦ í™•ì¸ (ê¸°ìˆ ê¸°ì—… ëª©ë¡ì„ ë³´ë ¤ë©´ ë””ìì¸ì „ë¬¸ê¸°ì—… CSVì— ì´ë©”ì¼ì´ ìˆì–´ì•¼ í•¨)
  async function verifyEmail() {
    userEmail = getEmailFromURL();
    
    if (!userEmail) {
      alert('ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. í™ˆí˜ì´ì§€ì—ì„œ ì´ë©”ì¼ ì¸ì¦ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.');
      window.location.href = 'index.html';
      return false;
    }

    const readOnlyParam = new URLSearchParams(window.location.search).get('readonly') === '1';
    if (isReadOnlyEmail(userEmail) || readOnlyParam) {
      isReadOnly = true;
      enterReadOnlyMode();
      return true;
    }
    
    try {
      // ë””ìì¸ì „ë¬¸ê¸°ì—… CSVì—ì„œ ì´ë©”ì¼ í™•ì¸
      const res = await fetch(DESIGN_CSV_URL);
      const text = await res.text();
      const designData = parseCSVForAuth(text);
      
      const found = designData.find(company => {
        const email = (company['ì‚¬ìš©ì ì´ë¦„'] || '').toLowerCase().trim();
        return email === userEmail.toLowerCase().trim();
      });
      
      if (!found) {
        alert('ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ë“±ë¡ëœ ë””ìì¸ì „ë¬¸ê¸°ì—… ì´ë©”ì¼ ì£¼ì†Œë¡œë§Œ ê¸°ìˆ ê¸°ì—… ëª©ë¡ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        window.location.href = 'index.html';
        return false;
      }
      
      // ì‚¬ìš©ì ì†Œì† ê¸°ì—…ëª… ì €ì¥ (ì „ì—­ ë³€ìˆ˜)
      window.userCompanyName = found['ê¸°ì—…ëª…'] || found['ìŠ¤íƒ€íŠ¸ì—…'] || found['ë””ìì¸ì „ë¬¸ê¸°ì—…'] || '';
      
      return true;
    } catch (e) {
      console.error('ì¸ì¦ ì˜¤ë¥˜:', e);
      alert('ì¸ì¦ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      window.location.href = 'index.html';
      return false;
    }
  }
  
  // ì¸ì¦ìš© ê°„ë‹¨í•œ CSV íŒŒì‹±
  function parseCSVForAuth(text) {
    const lines = text.split(/\r?\n/).filter(line => line.trim());
    if (lines.length < 2) return [];
    
    const headers = parseCSVLineForAuth(lines[0]);
    const data = [];
    
    for (let i = 1; i < lines.length; i++) {
      const values = parseCSVLineForAuth(lines[i]);
      const row = {};
      headers.forEach((h, idx) => {
        row[h] = values[idx] || '';
      });
      data.push(row);
    }
    
    return data;
  }
  
  function parseCSVLineForAuth(line) {
    const values = [];
    let current = '';
    let inQuotes = false;
    
    for (let i = 0; i < line.length; i++) {
      const char = line[i];
      const nextChar = line[i + 1];
      
      if (char === '"') {
        if (inQuotes && nextChar === '"') {
          current += '"';
          i++;
        } else {
          inQuotes = !inQuotes;
        }
      } else if (char === ',' && !inQuotes) {
        values.push(current.trim());
        current = '';
      } else {
        current += char;
      }
    }
    values.push(current.trim());
    return values;
  }

  async function loadCSV(){
    // ë¨¼ì € ì´ë©”ì¼ ì¸ì¦ í™•ì¸
    const isAuthorized = await verifyEmail();
    if (!isAuthorized) {
      return;
    }
    
    const resultsArea = document.getElementById('results');
    
    resultsArea.innerHTML = '<p class="muted">â³ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
    
    try {
      const res = await fetch(CSV_URL, {
        method: 'GET',
        cache: 'no-store'
      });
      
      if(!res.ok) throw new Error('HTTP ' + res.status);
      
      const text = await res.text();
      
      if(!text || text.length < 10){
        throw new Error('ë¹ˆ ì‘ë‹µ ë˜ëŠ” ì˜ëª»ëœ ë°ì´í„°');
      }
      
      const parsed = parseCSV(text);
      
      if(parsed.rows.length === 0){
        throw new Error('ë°ì´í„° í–‰ì´ ì—†ìŠµë‹ˆë‹¤');
      }
      
      rows = parsed.rows;
      headerMap = buildHeaderMap(parsed.headers);
      
      // í•„í„° ë²„íŠ¼ ìƒì„±
      buildFilterButtons();
      
      if (!isReadOnly) {
        // ë°‹ì—… ì‹ ì²­ ìŠ¬ë¡¯ ì´ˆê¸°í™” ë° ê¸°ì¡´ ì„ íƒ ë¡œë“œ
        initMeetupSlots();
        await loadSelections();
        updateSubmitButton();
      } else {
        enterReadOnlyMode();
      }
      
      // ê²€ìƒ‰ì°½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
      const searchInput = document.getElementById('searchInput');
      let isComposing = false;
      
      searchInput.addEventListener('compositionstart', () => {
        isComposing = true;
      });
      
      searchInput.addEventListener('compositionend', (e) => {
        isComposing = false;
        searchKeyword = e.target.value.trim().toLowerCase();
        applyFilter();
      });
      
      searchInput.addEventListener('input', (e) => {
        if (!isComposing) {
          searchKeyword = e.target.value.trim().toLowerCase();
          applyFilter();
        }
      });
      
      applyFilter(); // ì´ˆê¸° ë¡œë“œ ì‹œ í•„í„° ì ìš©
    } catch(e) {
      console.error('CSV ë¡œë“œ ì˜¤ë¥˜:', e);
      resultsArea.innerHTML = `
        <div style="padding:20px; border:3px solid #DC2626; border-radius:12px; background:#FFF5F5; margin:20px 0;">
          <h3 style="color:#DC2626; margin-top:0;">âŒ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨</h3>
          <p class="muted">${e.message}</p>
          <p class="muted" style="font-size:12px; margin-top:10px;">CSV URLì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
        </div>
      `;
    }
  }

  function parseCSV(text){
    const rows = [];
    let currentRow = '';
    let insideQuotes = false;
    
    for(let i = 0; i < text.length; i++){
      const char = text[i];
      const nextChar = text[i + 1];
      
      if(char === '"'){
        currentRow += '"';
        if(insideQuotes && nextChar === '"'){
          currentRow += '"';
          i++;
        } else {
          insideQuotes = !insideQuotes;
        }
      } else if(char === '\n' && !insideQuotes){
        if(currentRow.trim().length > 0){
          rows.push(currentRow);
        }
        currentRow = '';
      } else if(char === '\r'){
        // \r ë¬´ì‹œ
      } else {
        currentRow += char;
      }
    }
    
    if(currentRow.trim().length > 0){
      rows.push(currentRow);
    }
    
    const headers = splitLine(rows[0]).map(h=>h.replace(/^\uFEFF/, '').trim());
    const dataRows = rows.slice(1).map(line=>{
      const values = splitLine(line);
      const o = {};
      headers.forEach((h,i)=> o[h] = (values[i]||'').trim());
      return o;
    });
    return {headers, rows: dataRows};
  }

  function splitLine(line){
    const result = [];
    let current = '';
    let inQuotes = false;
    
    for(let i = 0; i < line.length; i++){
      const char = line[i];
      const nextChar = line[i + 1];
      
      if(char === '"'){
        if(inQuotes && nextChar === '"'){
          current += '"';
          i++;
        } else {
          inQuotes = !inQuotes;
        }
      } else if(char === ',' && !inQuotes){
        result.push(current);
        current = '';
      } else {
        current += char;
      }
    }
    
    result.push(current);
    return result;
  }

  function buildHeaderMap(headers){
    const map = {};
    headers.forEach((h, i) => {
      map[h] = i;
    });
    return map;
  }

  function buildFilterButtons() {
    // ëª¨ë“  ì£¼ìš” ì‚¬ì—… ë¶„ì•¼ ì¶”ì¶œ (ì£¼ìš” ì‚¬ì—… ë¶„ì•¼_1~5ì—ì„œ)
    const allFields = new Set();
    rows.forEach(r => {
      // ì£¼ìš” ì‚¬ì—… ë¶„ì•¼_1~5 ëª¨ë‘ í™•ì¸
      for(let i = 1; i <= 5; i++) {
        const field = r[`ì£¼ìš” ì‚¬ì—… ë¶„ì•¼_${i}`] || '';
        if (field && field.trim()) {
          allFields.add(field.trim());
        }
      }
    });
    
    // í•„í„° ë²„íŠ¼ ìƒì„±
    const filterContainer = document.getElementById('filterButtons');
    const sortedFields = Array.from(allFields).sort();
    
    // "ì „ì²´" ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    const allBtn = filterContainer.querySelector('.filter-btn[data-filter=""]');
    if (allBtn) {
      allBtn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        allBtn.classList.add('active');
        selectedFilters = [];
        applyFilter();
      });
    }
    
    sortedFields.forEach(field => {
      const btn = document.createElement('button');
      btn.className = 'filter-btn';
      btn.textContent = field;
      btn.dataset.filter = field;
      btn.addEventListener('click', () => {
        // "ì „ì²´" ë²„íŠ¼ ë¹„í™œì„±í™”
        allBtn.classList.remove('active');
        
        // í† ê¸€ ë°©ì‹: ì´ë¯¸ ì„ íƒë˜ì–´ ìˆìœ¼ë©´ ì œê±°, ì—†ìœ¼ë©´ ì¶”ê°€
        const index = selectedFilters.indexOf(field);
        if (index > -1) {
          selectedFilters.splice(index, 1);
          btn.classList.remove('active');
        } else {
          selectedFilters.push(field);
          btn.classList.add('active');
        }
        
        // ì„ íƒëœ í•„í„°ê°€ ì—†ìœ¼ë©´ "ì „ì²´" ë²„íŠ¼ í™œì„±í™”
        if (selectedFilters.length === 0) {
          allBtn.classList.add('active');
        }
        
        applyFilter();
      });
      filterContainer.appendChild(btn);
    });
  }

  function applyFilter(){
    const filtered = rows.filter(r=>{
      // ê²€ìƒ‰ í‚¤ì›Œë“œ í•„í„°
      if(searchKeyword) {
        const companyName = r['ê¸°ì—…ëª…'] || r['ë©˜í† ëª…'] || r['ê¸°ìˆ ê¸°ì—…ëª…'] || r['íšŒì‚¬ëª…'] || '';
        if(!companyName.toLowerCase().includes(searchKeyword)) {
          return false;
        }
      }
      
      // ì£¼ìš” ì‚¬ì—… ë¶„ì•¼ í•„í„° (ë³µìˆ˜ ì„ íƒ - OR ì¡°ê±´, ì£¼ìš” ì‚¬ì—… ë¶„ì•¼_1~5 ëª¨ë‘ í™•ì¸)
      if(selectedFilters.length > 0) {
        let found = false;
        // ì„ íƒí•œ í•„í„° ì¤‘ í•˜ë‚˜ë¼ë„ í¬í•¨ë˜ë©´ í‘œì‹œ
        for(let i = 1; i <= 5; i++) {
          const field = r[`ì£¼ìš” ì‚¬ì—… ë¶„ì•¼_${i}`] || '';
          if (field && field.trim() && selectedFilters.includes(field.trim())) {
            found = true;
            break;
          }
        }
        if (!found) {
          return false;
        }
      }
      
      return true;
    });
    render(filtered);
  }

  function render(list){
    const area = document.getElementById('results');
    area.innerHTML = '';
    
    const validList = list.filter(r => {
      const name = r['ê¸°ì—…ëª…'] || r['ë©˜í† ëª…'] || r['ê¸°ìˆ ê¸°ì—…ëª…'] || r['íšŒì‚¬ëª…'] || '';
      return name && name.trim().length > 0;
    });
    
    if(validList.length===0){ 
      area.innerHTML = '<p class="muted">ì¡°ê±´ì— ë§ëŠ” ê¸°ìˆ ê¸°ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; 
      return; 
    }
    
    validList.forEach(r=>{
      const card = document.createElement('div');
      card.className = 'card';
      
      const companyName = r['ê¸°ì—…ëª…'] || r['ë©˜í† ëª…'] || r['ê¸°ìˆ ê¸°ì—…ëª…'] || r['íšŒì‚¬ëª…'] || 'ê¸°ìˆ ê¸°ì—…';
      
      // ì„ íƒëœ ì¹´ë“œì¸ì§€ í™•ì¸
      const selectedPriority = getSelectedPriority(companyName);
      if(selectedPriority) {
        card.classList.add('selected');
        card.innerHTML = `<div class="card-selected-badge">${selectedPriority}</div>`;
      }
      
      let html = selectedPriority ? '' : '';
      html += `<h3>${companyName}</h3>`;
      
      // ê°„ëµì†Œê°œ í‘œì‹œ (ì¹´ë“œ í‘œë©´ì—ë§Œ)
      const briefIntro = r['ê°„ëµì†Œê°œ'] || '';
      if(briefIntro){
        html += `<div class="card-desc">${briefIntro}</div>`;
      } else {
        // ê°„ëµì†Œê°œê°€ ì—†ìœ¼ë©´ ì£¼ìš” ì—­ëŸ‰ í‘œì‹œ (í•˜ìœ„ í˜¸í™˜ì„±)
        const capability = r['ì£¼ìš” ì—­ëŸ‰'] || '';
        if(capability){
          html += `<div class="card-desc">${capability}</div>`;
        }
      }
      
      // í™ˆí˜ì´ì§€ ë§í¬ í‘œì‹œ (ì¹´ë“œ í‘œë©´ì—)
      const homepageFields = ['í™ˆí˜ì´ì§€', 'ì›¹ì‚¬ì´íŠ¸', 'website', 'homepage', 'Website', 'Homepage'];
      for (const field of homepageFields) {
        if (r[field] && r[field].trim()) {
          let url = r[field].trim();
          // http:// ë˜ëŠ” https://ê°€ ì—†ìœ¼ë©´ ì¶”ê°€
          if (!/^https?:\/\//i.test(url)) {
            url = 'https://' + url;
          }
          // URL ìœ íš¨ì„± ê°„ë‹¨ ì²´í¬
          if (/^https?:\/\/.+/.test(url)) {
            html += `<div class="card-homepage" style="margin-top: 8px; font-size: 12px;"><a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer" style="color: #DC2626; text-decoration: underline;" onclick="event.stopPropagation();">ğŸŒ ${escapeHtml(r[field])}</a></div>`;
          }
          break; // ì²« ë²ˆì§¸ í™ˆí˜ì´ì§€ í•„ë“œë§Œ í‘œì‹œ
        }
      }
      
      // íƒœê·¸ë“¤
      html += '<div class="card-tags">';
      // ì£¼ìš” ì‚¬ì—… ë¶„ì•¼_1~5 ëª¨ë‘ í‘œì‹œ
      for(let i = 1; i <= 5; i++) {
        const field = r[`ì£¼ìš” ì‚¬ì—… ë¶„ì•¼_${i}`];
        if(field && field.trim()) {
          html += `<span class="card-badge">${field.trim()}</span>`;
        }
      }
      if(r['ê¸°ì—…ê·œëª¨']) html += `<span class="card-badge">${r['ê¸°ì—…ê·œëª¨']}</span>`;
      // ê´€ì‹¬ë¶„ì•¼_1~6 ëª¨ë‘ í‘œì‹œ
      for(let i = 1; i <= 6; i++) {
        const interest = r[`ê´€ì‹¬ë¶„ì•¼_${i}`];
        if(interest && interest.trim()) {
          html += `<span class="card-badge">${interest.trim()}</span>`;
        }
      }
      html += '</div>';
      
      if (!isReadOnly) {
        const btnText = selectedPriority ? `âœ“ ì‹ ì²­ë¨ (${selectedPriority})` : '+ ë°‹ì—…ì‹ ì²­';
        const btnClass = selectedPriority ? 'meetup-btn added' : 'meetup-btn';
        html += `<button class="${btnClass}" onclick="event.stopPropagation(); addToMeetup(${JSON.stringify(r).replace(/"/g, '&quot;')})">${btnText}</button>`;
      }
      
      card.innerHTML += html;
      
      card.addEventListener('click', ()=>showModal(r));
      area.appendChild(card);
    });
  }
  
  // ì„ íƒëœ ìš°ì„ ìˆœìœ„ ê°€ì ¸ì˜¤ê¸°
  function getSelectedPriority(companyName) {
    for(let priority = 1; priority <= 7; priority++) {
      if(selections[priority] && selections[priority].companyName === companyName) {
        return priority;
      }
    }
    return null;
  }
  
  // ë°‹ì—… ì‹ ì²­ ìŠ¬ë¡¯ ì´ˆê¸°í™”
  function initMeetupSlots() {
    if (isReadOnly) return;
    const container = document.getElementById('slotsContainer');
    container.innerHTML = '';
    
    for(let i = 1; i <= 7; i++) {
      const slot = document.createElement('div');
      slot.className = 'slot';
      slot.dataset.priority = i;
      
      slot.innerHTML = `
        <div class="slot-number">${i}</div>
        <div class="slot-content">
          <div class="slot-empty-text">ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
        </div>
        <button class="slot-remove" onclick="removeSelection(${i})" style="display: none;">Ã—</button>
      `;
      
      container.appendChild(slot);
    }
  }
  
  // ì„ íƒ ì¶”ê°€/ì—…ë°ì´íŠ¸ (ë¡œì»¬ë§Œ, ì„œë²„ ì €ì¥ì€ ì œì¶œí•˜ê¸° ë²„íŠ¼ì—ì„œ)
  function addSelection(priority, companyData) {
    if (isReadOnly) {
      alert('ì´ ê³„ì •ì€ ëª©ë¡ ì¡°íšŒ ì „ìš©ì…ë‹ˆë‹¤.');
      return;
    }
    const companyName = companyData['ê¸°ì—…ëª…'] || companyData['ë©˜í† ëª…'] || companyData['ê¸°ìˆ ê¸°ì—…ëª…'] || companyData['íšŒì‚¬ëª…'] || '';
    
    if(!companyName) return;
    
    // ê°™ì€ ê¸°ì—…ì´ ë‹¤ë¥¸ ìš°ì„ ìˆœìœ„ì— ìˆìœ¼ë©´ ì œê±°
    for(let p = 1; p <= 7; p++) {
      if(selections[p] && selections[p].companyName === companyName && p !== priority) {
        delete selections[p];
        updateSlotDisplay(p);
      }
    }
    
    // ìƒˆ ì„ íƒ ì¶”ê°€
    selections[priority] = {
      companyName: companyName,
      companyData: companyData
    };
    
    updateSlotDisplay(priority);
    // ì¹´ë“œ ë‹¤ì‹œ ë Œë”ë§í•˜ì—¬ ë°°ì§€ ì—…ë°ì´íŠ¸ (rowsê°€ ìˆì„ ë•Œë§Œ)
    if(rows.length > 0) {
      render(rows);
    }
    
    // ì œì¶œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    updateSubmitButton();
  }
  
  // ì œì¶œí•˜ê¸° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
  function updateSubmitButton() {
    const submitBtn = document.getElementById('submitBtn');
    if(!submitBtn) return;
    if (isReadOnly) {
      submitBtn.disabled = true;
      return;
    }
    const hasSelections = Object.keys(selections).length > 0;
    submitBtn.disabled = !hasSelections;
  }
  
  // ì œì¶œí•˜ê¸° - ëª¨ë“  ì„ íƒì„ ì„œë²„ì— ì €ì¥
  async function submitSelections() {
    if (isReadOnly) {
      alert('ì´ ê³„ì •ì€ ëª©ë¡ ì¡°íšŒ ì „ìš©ì…ë‹ˆë‹¤.');
      return;
    }
    const selectedCount = Object.keys(selections).length;
    if(selectedCount === 0) {
      alert('ì„ íƒí•œ ê¸°ì—…ì´ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    if(!confirm(`ì´ ${selectedCount}ê°œì˜ ê¸°ì—…ì„ ë°‹ì—… ì‹ ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
      return;
    }
    
    // ê¸°ì¡´ ì„ íƒ ëª¨ë‘ ì‚­ì œ í›„ ìƒˆë¡œ ì €ì¥
    try {
      // ê¸°ì¡´ ì„ íƒ ì‚­ì œ
      console.log('ê¸°ì¡´ ì„ íƒ ì‚­ì œ ì‹œì‘...');
      try {
        const deleteRes = await fetch(`/api/kidp2025/meetup/selections?email=${encodeURIComponent(userEmail)}&listType=tech`, {
          method: 'DELETE'
        });
        if (!deleteRes.ok) {
          let deleteError;
          try {
            deleteError = await deleteRes.json();
          } catch (e) {
            const text = await deleteRes.text();
            deleteError = { error: 'JSON íŒŒì‹± ì‹¤íŒ¨', raw: text };
          }
          console.warn('ê¸°ì¡´ ì„ íƒ ì‚­ì œ ê²½ê³ :', JSON.stringify(deleteError, null, 2));
        } else {
          const deleteResult = await deleteRes.json().catch(() => ({}));
          console.log('ê¸°ì¡´ ì„ íƒ ì‚­ì œ ì™„ë£Œ:', JSON.stringify(deleteResult, null, 2));
        }
      } catch (deleteErr) {
        console.warn('ê¸°ì¡´ ì„ íƒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ (ë¬´ì‹œí•˜ê³  ê³„ì†):', deleteErr);
      }
      
      // ìƒˆ ì„ íƒ ì €ì¥
      console.log('ìƒˆ ì„ íƒ ì €ì¥ ì‹œì‘...', `ì´ ${Object.keys(selections).length}ê°œ`);
      const savePromises = [];
      for(let priority = 1; priority <= 7; priority++) {
        if(selections[priority]) {
          const sel = selections[priority];
          console.log(`ìš°ì„ ìˆœìœ„ ${priority} ì €ì¥ ì‹œë„:`, sel.companyName);
          savePromises.push(
            fetch('/api/kidp2025/meetup/selections', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                email: userEmail,
                companyName: sel.companyName,
                priority: priority,
                listType: 'tech',
                companyData: {
                  ...sel.companyData,
                  'ì‚¬ìš©ì ì†Œì† ê¸°ì—…': window.userCompanyName || ''
                }
              })
            }).then(async (res) => {
              let result;
              try {
                result = await res.json();
              } catch (jsonError) {
                const text = await res.text();
                console.error(`ìš°ì„ ìˆœìœ„ ${priority} JSON íŒŒì‹± ì‹¤íŒ¨:`, text);
                throw new Error(`ìš°ì„ ìˆœìœ„ ${priority} (${sel.companyName}): ì„œë²„ ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨ - ${text.substring(0, 200)}`);
              }
              
              if (!res.ok) {
                const errorMsg = result.error || result.details || 'ì €ì¥ ì‹¤íŒ¨';
                const errorType = result.type || 'Unknown';
                console.error(`ìš°ì„ ìˆœìœ„ ${priority} ì €ì¥ ì‹¤íŒ¨:`, JSON.stringify({
                  status: res.status,
                  statusText: res.statusText,
                  error: errorMsg,
                  type: errorType,
                  fullResponse: result
                }, null, 2));
                throw new Error(`ìš°ì„ ìˆœìœ„ ${priority} (${sel.companyName}): ${errorMsg} [${errorType}]`);
              }
              console.log(`ìš°ì„ ìˆœìœ„ ${priority} ì €ì¥ ì„±ê³µ:`, JSON.stringify(result, null, 2));
              return result;
            }).catch((err) => {
              console.error(`ìš°ì„ ìˆœìœ„ ${priority} ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:`, err);
              throw new Error(`ìš°ì„ ìˆœìœ„ ${priority} (${sel.companyName}): ${err.message || 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜'}`);
            })
          );
        }
      }
      
      const results = await Promise.all(savePromises);
      console.log('ëª¨ë“  ì„ íƒ ì €ì¥ ì™„ë£Œ:', results);
      
      // ì›¹í›… í˜¸ì¶œ ì—¬ë¶€ í™•ì¸
      if (results.length > 0 && results[0]) {
        const webhookUrl = results[0].webhookUrl;
        console.log('ì„œë²„ ì‘ë‹µ ì •ë³´:', {
          webhookCalled: results[0].webhookCalled,
          webhookUrl: webhookUrl
        });
        
        // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (ë‚˜ì¤‘ì— í…ŒìŠ¤íŠ¸ìš©)
        window.testWebhookUrl = webhookUrl;
        console.log('ğŸ’¡ ì›¹í›… í…ŒìŠ¤íŠ¸: ì½˜ì†”ì— "testWebhook()" ì…ë ¥');
        
        // ì „ì—­ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ ì •ì˜
        window.testWebhook = function() {
          if (!window.testWebhookUrl) {
            console.error('ì›¹í›… URLì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì œì¶œí•˜ê¸°ë¥¼ í´ë¦­í•˜ì„¸ìš”.');
            return;
          }
          console.log('ì›¹í›… í…ŒìŠ¤íŠ¸ ì‹œì‘:', window.testWebhookUrl);
          fetch(window.testWebhookUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email: 'test@test.com',
              companyName: 'í…ŒìŠ¤íŠ¸ ê¸°ì—…',
              priority: 1,
              listType: 'tech',
              companyData: { test: 'data' },
              createdAt: new Date().toISOString(),
              updatedAt: new Date().toISOString()
            })
          }).then(r => {
            console.log('ìƒíƒœ ì½”ë“œ:', r.status);
            console.log('ì‘ë‹µ URL:', r.url);
            return r.text();
          }).then(text => {
            console.log('ì‘ë‹µ ë‚´ìš©:', text);
            if (text.includes('<html') || text.includes('<!DOCTYPE')) {
              console.error('âš ï¸ HTML ì˜¤ë¥˜ í˜ì´ì§€ê°€ ë°˜í™˜ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } else {
              try {
                const json = JSON.parse(text);
                console.log('JSON ì‘ë‹µ:', json);
              } catch(e) {
                console.log('JSON íŒŒì‹± ì‹¤íŒ¨, í…ìŠ¤íŠ¸ ì‘ë‹µ:', text);
              }
            }
          }).catch(err => {
            console.error('ì›¹í›… í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜:', err);
          });
        };
        
        if (!results[0].webhookCalled) {
          console.warn('âš ï¸ Google Sheets ì›¹í›…ì´ í˜¸ì¶œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í™˜ê²½ ë³€ìˆ˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        }
      }
      
      alert('ë°‹ì—… ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
    } catch(e) {
      console.error('ì œì¶œ ì˜¤ë¥˜ ìƒì„¸:', {
        message: e.message,
        stack: e.stack,
        error: e
      });
      const errorMessage = e.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
      alert(`ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\nì˜¤ë¥˜ ë‚´ìš©: ${errorMessage}\n\në¸Œë¼ìš°ì € ì½˜ì†”(F12)ì—ì„œ ìì„¸í•œ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.`);
    }
  }
  
  // ë‹¤ì‹œì„ íƒí•˜ê¸° - ìŠ¬ë¡¯ ì´ˆê¸°í™”
  async function resetSelections() {
    if (isReadOnly) {
      alert('ì´ ê³„ì •ì€ ëª©ë¡ ì¡°íšŒ ì „ìš©ì…ë‹ˆë‹¤.');
      return;
    }
    const selectedCount = Object.keys(selections).length;
    if(selectedCount === 0) {
      return;
    }
    
    if(!confirm('ëª¨ë“  ì„ íƒì„ ì·¨ì†Œí•˜ê³  ë‹¤ì‹œ ì„ íƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      return;
    }
    
    try {
      // ì„œë²„ì—ì„œ ëª¨ë“  ì„ íƒ ì‚­ì œ
      await fetch(`/api/kidp2025/meetup/selections?email=${encodeURIComponent(userEmail)}&listType=tech`, {
        method: 'DELETE'
      });
      
      // ë¡œì»¬ ì„ íƒ ì´ˆê¸°í™”
      selections = {};
      for(let i = 1; i <= 7; i++) {
        updateSlotDisplay(i);
      }
      
      // ì¹´ë“œ ë‹¤ì‹œ ë Œë”ë§
      if(rows.length > 0) {
        render(rows);
      }
      
      // ì œì¶œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
      updateSubmitButton();
    } catch(e) {
      console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', e);
      alert('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  }
  
  // ì„ íƒ ì œê±° (ë¡œì»¬ë§Œ, ì„œë²„ ì‚­ì œëŠ” ì œì¶œí•˜ê¸°/ë‹¤ì‹œì„ íƒí•˜ê¸°ì—ì„œ)
  function removeSelection(priority) {
    if(selections[priority]) {
      delete selections[priority];
      updateSlotDisplay(priority);
      // ì¹´ë“œ ë‹¤ì‹œ ë Œë”ë§í•˜ì—¬ ë°°ì§€ ì œê±° (rowsê°€ ìˆì„ ë•Œë§Œ)
      if(rows.length > 0) {
        render(rows);
      }
      
      // ì œì¶œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
      updateSubmitButton();
    }
  }
  
  // ìŠ¬ë¡¯ í‘œì‹œ ì—…ë°ì´íŠ¸
  function updateSlotDisplay(priority) {
    const slot = document.querySelector(`.slot[data-priority="${priority}"]`);
    if(!slot) return;
    
    const content = slot.querySelector('.slot-content');
    const removeBtn = slot.querySelector('.slot-remove');
    
    if(selections[priority]) {
      slot.classList.add('filled');
      content.innerHTML = selections[priority].companyName;
      removeBtn.style.display = 'flex';
    } else {
      slot.classList.remove('filled');
      content.innerHTML = '<div class="slot-empty-text">ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</div>';
      removeBtn.style.display = 'none';
    }
  }
  
      // ê¸°ì¡´ ì„ íƒ ë¡œë“œ
  async function loadSelections() {
    if(!userEmail || isReadOnly) return;
    
    try {
      const response = await fetch(`/api/kidp2025/meetup/selections?email=${encodeURIComponent(userEmail)}&listType=tech`);
      const data = await response.json();
      
      if(data.success && data.selections) {
        selections = {};
        data.selections.forEach(sel => {
          selections[sel.priority] = {
            companyName: sel.companyName,
            companyData: sel.companyData
          };
          updateSlotDisplay(sel.priority);
        });
        // ì„ íƒ ë¡œë“œ í›„ ì¹´ë“œ ë‹¤ì‹œ ë Œë”ë§í•˜ì—¬ ë°°ì§€ í‘œì‹œ
        if(rows.length > 0) {
          render(rows);
        }
      }
    } catch(e) {
      console.error('ì„ íƒ ë¡œë“œ ì˜¤ë¥˜:', e);
    }
  }
  
  function showModal(data){
    const modal = document.getElementById('detailModal');
    const content = document.getElementById('modalContent');
    
    const companyName = data['ê¸°ì—…ëª…'] || data['ë©˜í† ëª…'] || data['ê¸°ìˆ ê¸°ì—…ëª…'] || data['íšŒì‚¬ëª…'] || 'ê¸°ìˆ ê¸°ì—…';
    const selectedPriority = getSelectedPriority(companyName);
    
    let html = `
      <span class="modal-close" onclick="closeModal()">&times;</span>
      <h2>${companyName}</h2>
    `;
    
    // ëª¨ë“  í•„ë“œ í‘œì‹œ (ì‚¬ìš©ì ì´ë¦„, ê°„ëµì†Œê°œ ì œì™¸)
    Object.keys(data).forEach(key => {
      if(data[key] && data[key].trim() && 
         key !== 'ê¸°ì—…ëª…' && key !== 'ë©˜í† ëª…' && key !== 'ê¸°ìˆ ê¸°ì—…ëª…' && key !== 'íšŒì‚¬ëª…' &&
         key !== 'ì‚¬ìš©ì ì´ë¦„' && key !== 'ê°„ëµì†Œê°œ'){
        
        // í™ˆí˜ì´ì§€ í•„ë“œì¸ì§€ í™•ì¸ (í™ˆí˜ì´ì§€, ì›¹ì‚¬ì´íŠ¸, website, homepage ë“±)
        const isHomepageField = /í™ˆí˜ì´ì§€|ì›¹ì‚¬ì´íŠ¸|website|homepage/i.test(key);
        let value = data[key];
        
        if (isHomepageField) {
          // URL í˜•ì‹ì¸ì§€ í™•ì¸í•˜ê³  í•˜ì´í¼ë§í¬ë¡œ ë³€í™˜
          let url = value.trim();
          // http:// ë˜ëŠ” https://ê°€ ì—†ìœ¼ë©´ ì¶”ê°€
          if (!/^https?:\/\//i.test(url)) {
            url = 'https://' + url;
          }
          // URL ìœ íš¨ì„± ê°„ë‹¨ ì²´í¬
          if (/^https?:\/\/.+/.test(url)) {
            value = `<a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer" style="color: #DC2626; text-decoration: underline;">${escapeHtml(data[key])}</a>`;
          } else {
            value = escapeHtml(data[key]);
          }
        } else {
          value = escapeHtml(data[key]);
        }
        
        html += `
          <div class="modal-row">
            <div class="modal-label">${key}</div>
            <div class="modal-value">${value}</div>
          </div>
        `;
      }
    });
    
    // ëª¨ë‹¬ ë‚´ë¶€ ë°‹ì—… ì‹ ì²­ ë²„íŠ¼ (ì½ê¸° ì „ìš© ì œì™¸)
    if (!isReadOnly) {
      const btnText = selectedPriority ? `âœ“ ë°‹ì—… ì‹ ì²­ë¨ (ìš°ì„ ìˆœìœ„ ${selectedPriority})` : '+ ë°‹ì—…ì‹ ì²­';
      const btnClass = selectedPriority ? 'modal-meetup-btn added' : 'modal-meetup-btn';
      const escapedData = JSON.stringify(data).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
      html += `<button class="${btnClass}" onclick="addToMeetup(${escapedData})">${btnText}</button>`;
    }
    
    content.innerHTML = html;
    modal.classList.add('show');
  }
  
  // ë¹ˆ ìŠ¬ë¡¯ ì°¾ì•„ì„œ ìë™ìœ¼ë¡œ ì¶”ê°€
  function addToMeetup(companyData) {
    // ë¹ˆ ìŠ¬ë¡¯ ì¤‘ ê°€ì¥ ë‚®ì€ ë²ˆí˜¸ ì°¾ê¸°
    let emptySlot = null;
    for(let i = 1; i <= 7; i++) {
      if(!selections[i]) {
        emptySlot = i;
        break;
      }
    }
    
    if(emptySlot === null) {
      alert('ë°‹ì—… ì‹ ì²­ì€ ìµœëŒ€ 7ê°œê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤. ê¸°ì¡´ ì‹ ì²­ì„ ì œê±°í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    addSelection(emptySlot, companyData);
    // ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
    closeModal();
  }
  
  function closeModal(){
    document.getElementById('detailModal').classList.remove('show');
  }
  
  window.onclick = function(event){
    const modal = document.getElementById('detailModal');
    if(event.target === modal){
      closeModal();
    }
  };

  // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
  document.addEventListener('keydown', function(event){
    if(event.key === 'Escape' || event.keyCode === 27){
      const modal = document.getElementById('detailModal');
      if(modal.classList.contains('show')){
        closeModal();
      }
    }
  });

  loadCSV();
  </script>
</body>
</html>

