<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„ í˜¸ ì…ë ¥ - EpicStage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/common-styles.css">
    <!-- Swing.js for card swipe -->
    <script src="https://cdn.jsdelivr.net/npm/swing@3.1.1/dist/swing.min.js"></script>
    <!-- Fuse.js for search -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>
    <!-- Sortable.js for drag and drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        body {
            background: #FFFFFF;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        }
        /* ëª¨ë‹¬ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-overlay {
            animation: fadeIn 0.2s ease-out;
        }
        .modal-content {
            animation: slideUp 0.3s ease-out;
        }
        /* ì¹´ë“œ ìŠ¤ì™€ì´í”„ ìŠ¤íƒ€ì¼ */
        #cardStack {
            position: relative;
            width: 100%;
            max-width: 400px;
            height: 500px;
            margin: 0 auto;
        }
        .swing-card {
            position: absolute;
            width: 100%;
            height: 100%;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 24px;
            cursor: grab;
            user-select: none;
            transition: transform 0.2s;
        }
        .swing-card:active {
            cursor: grabbing;
        }
        .swing-card.dragging {
            transition: none;
        }
        .card-initials {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            margin: 0 auto 20px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- ì´ë¦„Â·íšŒì‚¬ëª… ì¬í™•ì¸ ëª¨ë‹¬ -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay z-50 flex items-center justify-center p-4" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl modal-content max-w-md w-full p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">ë³¸ì¸ í™•ì¸</h2>
            <div class="space-y-3 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì´ë¦„</label>
                    <div class="text-lg font-semibold text-gray-900" id="confirmName"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">íšŒì‚¬ëª…</label>
                    <div class="text-lg font-semibold text-gray-900" id="confirmCompany"></div>
                </div>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="confirmCancel" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                    ì·¨ì†Œ
                </button>
                <button id="confirmOk" class="px-4 py-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition">
                    í™•ì¸
                </button>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <div id="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            <p class="mt-4 text-gray-600">ë¡œë”© ì¤‘...</p>
        </div>

        <div id="error" class="hidden bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg mb-4">
            <p id="errorMessage"></p>
        </div>

        <!-- Step 1: ì¹´ë“œ ë¸Œë¼ìš°ì§• -->
        <div id="step1" class="hidden">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">ë§Œë‚˜ê³  ì‹¶ì€ íŒ€ì„ ë‹´ì•„ë³´ì„¸ìš”</h1>
            <p class="text-gray-600 mb-6">ë§ˆìŒì— ë“œëŠ” íŒ€ì€ 'ë‹´ê¸°'ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”. ë‚˜ì¤‘ì— ì´ ì¤‘ì—ì„œ 5ê°œë§Œ ê³¨ë¼ ìˆœìœ„ë¥¼ ì •í•©ë‹ˆë‹¤.</p>
            
            <!-- ê²€ìƒ‰ ë° í•„í„° -->
            <div class="mb-6 space-y-4">
                <div class="relative">
                    <input 
                        type="text" 
                        id="searchInput" 
                        placeholder="ì´ë¦„, íšŒì‚¬ëª…, í‚¤ì›Œë“œë¡œ ê²€ìƒ‰..." 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                    <svg class="absolute right-3 top-3.5 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
                <div class="flex flex-wrap gap-2">
                    <select id="industryFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">ì „ì²´ ì‚°ì—…</option>
                    </select>
                    <select id="stageFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">ì „ì²´ ë‹¨ê³„</option>
                    </select>
                </div>
            </div>

            <!-- ì¹´ë“œ ìŠ¤íƒ -->
            <div id="cardStack" class="mb-6"></div>

            <!-- ë‹´ì€ íŒ€ ì¹´ìš´íŠ¸ ë° ë‹¤ìŒ ë‹¨ê³„ ë²„íŠ¼ -->
            <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 shadow-lg">
                <div class="container mx-auto max-w-4xl flex items-center justify-between">
                    <div class="text-gray-700">
                        <span class="font-semibold" id="shortlistCount">0</span>ê°œ ë‹´ìŒ
                    </div>
                    <button 
                        id="nextStepBtn" 
                        class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled
                    >
                        ë‹¤ìŒ ë‹¨ê³„ â†’ ìˆœìœ„ ì •í•˜ê¸°
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 2: ìˆœìœ„ ì„¤ì • -->
        <div id="step2" class="hidden">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">ìˆœìœ„ë¥¼ ì •í•´ì£¼ì„¸ìš”</h1>
            <p class="text-gray-600 mb-6">ë‹´ì€ íŒ€ ì¤‘ì—ì„œ ìµœëŒ€ 5ê°œë¥¼ ì„ íƒí•˜ì—¬ ìˆœìœ„ë¥¼ ì •í•´ì£¼ì„¸ìš”. 1ìˆœìœ„ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.</p>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-24">
                <!-- ë‚˜ì˜ ì¹´ë“œí•¨ (Shortlist) -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">ë‚˜ì˜ ì¹´ë“œí•¨</h2>
                    <div id="shortlistContainer" class="space-y-3 min-h-[200px]">
                        <!-- ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                    </div>
                </div>

                <!-- ì„ í˜¸ ìˆœìœ„ ë¦¬ìŠ¤íŠ¸ (1~5) -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">ì„ í˜¸ ìˆœìœ„</h2>
                    <div id="rankList" class="space-y-3">
                        <div class="rank-slot" data-rank="1">
                            <div class="text-sm font-medium text-gray-500 mb-2">1ìˆœìœ„ (í•„ìˆ˜)</div>
                            <div class="min-h-[80px] border-2 border-dashed border-gray-300 rounded-lg p-4 flex items-center justify-center text-gray-400 rank-item">
                                ë¹„ì–´ìˆìŒ
                            </div>
                        </div>
                        <div class="rank-slot" data-rank="2">
                            <div class="text-sm font-medium text-gray-500 mb-2">2ìˆœìœ„</div>
                            <div class="min-h-[80px] border-2 border-dashed border-gray-300 rounded-lg p-4 flex items-center justify-center text-gray-400 rank-item">
                                ë¹„ì–´ìˆìŒ
                            </div>
                        </div>
                        <div class="rank-slot" data-rank="3">
                            <div class="text-sm font-medium text-gray-500 mb-2">3ìˆœìœ„</div>
                            <div class="min-h-[80px] border-2 border-dashed border-gray-300 rounded-lg p-4 flex items-center justify-center text-gray-400 rank-item">
                                ë¹„ì–´ìˆìŒ
                            </div>
                        </div>
                        <div class="rank-slot" data-rank="4">
                            <div class="text-sm font-medium text-gray-500 mb-2">4ìˆœìœ„</div>
                            <div class="min-h-[80px] border-2 border-dashed border-gray-300 rounded-lg p-4 flex items-center justify-center text-gray-400 rank-item">
                                ë¹„ì–´ìˆìŒ
                            </div>
                        </div>
                        <div class="rank-slot" data-rank="5">
                            <div class="text-sm font-medium text-gray-500 mb-2">5ìˆœìœ„</div>
                            <div class="min-h-[80px] border-2 border-dashed border-gray-300 rounded-lg p-4 flex items-center justify-center text-gray-400 rank-item">
                                ë¹„ì–´ìˆìŒ
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ë§Œë‚˜ê³  ì‹¶ì€ íŒ€ ì—†ìŒ ì˜µì…˜ -->
            <div class="mb-6">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" id="noneFlag" class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <span class="text-gray-700">ë§Œë‚˜ê³  ì‹¶ì€ íŒ€ì´ ì—†ìŠµë‹ˆë‹¤</span>
                </label>
            </div>

            <!-- í•˜ë‹¨ ë²„íŠ¼ -->
            <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 shadow-lg">
                <div class="container mx-auto max-w-4xl flex items-center justify-between">
                    <button 
                        id="backToStep1Btn" 
                        class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition"
                    >
                        â† ì´ì „ ë‹¨ê³„
                    </button>
                    <div class="flex gap-3">
                        <button 
                            id="saveDraftBtn" 
                            class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition"
                        >
                            ì„ì‹œ ì €ì¥
                        </button>
                        <button 
                            id="submitBtn" 
                            class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled
                        >
                            ì œì¶œí•˜ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // URLì—ì„œ ì´ë²¤íŠ¸ IDì™€ í† í° ì¶”ì¶œ
        // PRDì— ë”°ë¥´ë©´ /pref?event=123&token=... í˜•ì‹
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        const eventId = urlParams.get('event');

        let participantData = null;
        let allParticipants = [];
        let filteredParticipants = [];
        let shortlist = [];
        let swingStack = null;
        let fuse = null;
        const MAX_SHORTLIST = 15;
        let rankings = {}; // {1: participantId, 2: participantId, ...}
        let sortableShortlist = null;
        let sortableRanks = null;

        // ëª¨ë‹¬ ìš”ì†Œ
        const confirmModal = document.getElementById('confirmModal');
        const confirmName = document.getElementById('confirmName');
        const confirmCompany = document.getElementById('confirmCompany');
        const confirmOk = document.getElementById('confirmOk');
        const confirmCancel = document.getElementById('confirmCancel');

        // 2ì´ˆ íƒ€ì´ë¨¸ë¡œ ëª¨ë‹¬ ìë™ í‘œì‹œ
        let confirmTimer = null;

        // í† í° ê²€ì¦ ë° ì°¸ê°€ì ì •ë³´ ë¡œë“œ
        async function loadParticipantData() {
            if (!token || !eventId) {
                showError('í† í° ë˜ëŠ” ì´ë²¤íŠ¸ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            try {
                const response = await fetch(`/api/events/${eventId}/preferences/form?token=${encodeURIComponent(token)}`);
                
                if (!response.ok) {
                    const error = await response.json();
                    showError(error.error || 'ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }

                const data = await response.json();
                participantData = data.participant;

                // 2ì´ˆ í›„ ëª¨ë‹¬ í‘œì‹œ
                confirmTimer = setTimeout(() => {
                    showConfirmModal();
                }, 2000);

                // ì°¸ê°€ì ì •ë³´ í‘œì‹œ
                displayParticipantInfo();
            } catch (error) {
                console.error('ë¡œë“œ ì˜¤ë¥˜:', error);
                showError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì°¸ê°€ì ì •ë³´ í‘œì‹œ ë° ë°ì´í„° ë¡œë“œ
        async function displayParticipantInfo() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('step1').classList.remove('hidden');
            
            // ì°¸ê°€ì ëª©ë¡ ë¡œë“œ
            await loadParticipants();
            
            // Shortlist ë¡œë“œ
            loadShortlist();
            
            // Fuse.js ì´ˆê¸°í™”
            initFuse();
            
            // í•„í„° ì˜µì…˜ ì´ˆê¸°í™”
            initFilters();
            
            // Swing.js ì´ˆê¸°í™”
            initSwing();
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            setupEventListeners();
            
            // ì¹´ë“œ ë Œë”ë§
            renderCards();
        }

        // ì°¸ê°€ì ëª©ë¡ ë¡œë“œ
        async function loadParticipants() {
            try {
                const response = await fetch(`/api/events/${eventId}/participants?token=${encodeURIComponent(token)}`);
                if (!response.ok) {
                    throw new Error('ì°¸ê°€ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                const data = await response.json();
                allParticipants = data.participants || [];
                filteredParticipants = [...allParticipants];
            } catch (error) {
                console.error('ì°¸ê°€ì ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                showError('ì°¸ê°€ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // Shortlist localStorageì—ì„œ ë¡œë“œ
        function loadShortlist() {
            const stored = localStorage.getItem(`shortlist_${eventId}_${token}`);
            if (stored) {
                try {
                    shortlist = JSON.parse(stored);
                    updateShortlistCount();
                } catch (e) {
                    shortlist = [];
                }
            }
        }

        // Shortlist localStorageì— ì €ì¥
        function saveShortlist() {
            localStorage.setItem(`shortlist_${eventId}_${token}`, JSON.stringify(shortlist));
            updateShortlistCount();
        }

        // Shortlist ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
        function updateShortlistCount() {
            const count = shortlist.length;
            document.getElementById('shortlistCount').textContent = count;
            document.getElementById('nextStepBtn').disabled = count === 0;
        }

        // Fuse.js ì´ˆê¸°í™”
        function initFuse() {
            fuse = new Fuse(allParticipants, {
                keys: ['name', 'company', 'industry_tags', 'interests', 'business_type', 'team_info'],
                threshold: 0.3,
                includeScore: true
            });
        }

        // í•„í„° ì˜µì…˜ ì´ˆê¸°í™”
        function initFilters() {
            const industries = new Set();
            const stages = new Set();
            
            allParticipants.forEach(p => {
                if (p.industry_tags) {
                    p.industry_tags.split(',').forEach(tag => industries.add(tag.trim()));
                }
                if (p.business_type) {
                    stages.add(p.business_type.trim());
                }
            });

            const industryFilter = document.getElementById('industryFilter');
            Array.from(industries).sort().forEach(industry => {
                const option = document.createElement('option');
                option.value = industry;
                option.textContent = industry;
                industryFilter.appendChild(option);
            });

            const stageFilter = document.getElementById('stageFilter');
            Array.from(stages).sort().forEach(stage => {
                const option = document.createElement('option');
                option.value = stage;
                option.textContent = stage;
                stageFilter.appendChild(option);
            });
        }

        // Swing.js ì´ˆê¸°í™”
        function initSwing() {
            if (typeof Swing === 'undefined') {
                console.warn('Swing.jsê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìŠ¤ì™€ì´í”„ ê¸°ëŠ¥ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            const stack = Swing.Stack({
                allowedDirections: [Swing.DIRECTION.LEFT, Swing.DIRECTION.RIGHT],
                throwOutConfidence: (xOffset, yOffset, element) => {
                    return Math.min(Math.abs(xOffset) / (element.offsetWidth / 2), 1);
                }
            });

            swingStack = stack;
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupEventListeners() {
            // ê²€ìƒ‰
            document.getElementById('searchInput').addEventListener('input', handleSearch);
            
            // í•„í„°
            document.getElementById('industryFilter').addEventListener('change', handleFilter);
            document.getElementById('stageFilter').addEventListener('change', handleFilter);
            
            // ë‹¤ìŒ ë‹¨ê³„ ë²„íŠ¼
            document.getElementById('nextStepBtn').addEventListener('click', () => {
                showStep2();
            });

            // Step 2 ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.getElementById('backToStep1Btn').addEventListener('click', () => {
                showStep1();
            });

            document.getElementById('saveDraftBtn').addEventListener('click', () => {
                saveRankings();
                showNotification('ì„ì‹œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            });

            document.getElementById('submitBtn').addEventListener('click', () => {
                submitRankings();
            });

            document.getElementById('noneFlag').addEventListener('change', (e) => {
                if (e.target.checked) {
                    // ëª¨ë“  ìˆœìœ„ ë¹„ìš°ê¸°
                    clearAllRanks();
                }
                updateSubmitButton();
            });
        }

        // ê²€ìƒ‰ ì²˜ë¦¬
        function handleSearch(e) {
            const query = e.target.value.trim();
            if (!query) {
                filteredParticipants = [...allParticipants];
            } else {
                const results = fuse.search(query);
                filteredParticipants = results.map(r => r.item);
            }
            applyFilters();
        }

        // í•„í„° ì ìš©
        function handleFilter() {
            applyFilters();
        }

        function applyFilters() {
            const industry = document.getElementById('industryFilter').value;
            const stage = document.getElementById('stageFilter').value;

            let filtered = [...filteredParticipants];

            if (industry) {
                filtered = filtered.filter(p => 
                    p.industry_tags && p.industry_tags.includes(industry)
                );
            }

            if (stage) {
                filtered = filtered.filter(p => 
                    p.business_type && p.business_type.includes(stage)
                );
            }

            filteredParticipants = filtered;
            renderCards();
        }

        // ì¹´ë“œ ë Œë”ë§
        function renderCards() {
            const stack = document.getElementById('cardStack');
            stack.innerHTML = '';

            // ì´ë¯¸ ë‹´ê¸´ ì¹´ë“œëŠ” ì œì™¸
            const available = filteredParticipants.filter(p => 
                !shortlist.includes(p.id)
            );

            if (available.length === 0) {
                stack.innerHTML = '<div class="text-center text-gray-500 py-20">ë” ì´ìƒ í‘œì‹œí•  ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            // ìµœëŒ€ 5ì¥ì˜ ì¹´ë“œë§Œ í‘œì‹œ (ì„±ëŠ¥ ìµœì í™”)
            const cardsToShow = available.slice(0, 5);

            cardsToShow.forEach((participant, index) => {
                const card = createCard(participant, index);
                stack.appendChild(card);
            });

            // Swing.js ì¹´ë“œ ë“±ë¡ ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            if (swingStack && typeof Swing !== 'undefined') {
                Array.from(stack.children).forEach((card) => {
                    swingStack.createCard(card);
                    
                    card.addEventListener('throwout', (e) => {
                        // ì¹´ë“œê°€ ìŠ¤ì™€ì´í”„ë˜ë©´ ë‹¤ìŒ ì¹´ë“œ í‘œì‹œ
                        setTimeout(() => {
                            renderCards();
                        }, 300);
                    });
                });
            }
        }

        // ì¹´ë“œ ìƒì„±
        function createCard(participant, index) {
            const card = document.createElement('div');
            card.className = 'swing-card';
            card.style.zIndex = 100 - index;
            card.style.transform = `scale(${1 - index * 0.05}) translateY(${index * 10}px)`;
            card.dataset.participantId = participant.id;

            const initials = (participant.company || participant.name || '?')
                .substring(0, 2)
                .toUpperCase();

            const isInShortlist = shortlist.includes(participant.id);

            card.innerHTML = `
                <div class="card-initials">${initials}</div>
                <h3 class="text-2xl font-bold text-gray-900 mb-2">${participant.company || '-'}</h3>
                <p class="text-gray-600 mb-4">${participant.name || '-'}</p>
                ${participant.team_info ? `<p class="text-sm text-gray-500 mb-2">${participant.team_info}</p>` : ''}
                ${participant.industry_tags ? `<div class="flex flex-wrap gap-2 mb-4">
                    ${participant.industry_tags.split(',').map(tag => 
                        `<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">${tag.trim()}</span>`
                    ).join('')}
                </div>` : ''}
                <div class="flex gap-2 mt-6">
                    <button class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50" onclick="toggleShortlist(${participant.id})">
                        ${isInShortlist ? 'âœ“ ë‹´ê¹€' : 'ğŸ¤ ë‹´ê¸°'}
                    </button>
                    <button class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50" onclick="showCardDetail(${participant.id})">
                        ë”ë³´ê¸°
                    </button>
                </div>
            `;

            return card;
        }

        // Shortlist í† ê¸€
        function toggleShortlist(participantId) {
            const index = shortlist.indexOf(participantId);
            if (index > -1) {
                // ì´ë¯¸ ë‹´ê²¨ìˆìœ¼ë©´ ì œê±°
                shortlist.splice(index, 1);
            } else {
                // ìµœëŒ€ ê°œìˆ˜ í™•ì¸
                if (shortlist.length >= MAX_SHORTLIST) {
                    alert(`ìµœëŒ€ ${MAX_SHORTLIST}ê°œê¹Œì§€ ë‹´ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                    return;
                }
                shortlist.push(participantId);
            }
            saveShortlist();
            renderCards();
        }

        // ì¹´ë“œ ìƒì„¸ ë³´ê¸° (ì¶”í›„ êµ¬í˜„)
        function showCardDetail(participantId) {
            const participant = allParticipants.find(p => p.id === participantId);
            if (participant) {
                alert(`${participant.company}\n${participant.name}\n${participant.team_info || ''}`);
            }
        }

        // Step 2 í‘œì‹œ
        function showStep2() {
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
            
            // Shortlist ì¹´ë“œí•¨ ë Œë”ë§
            renderShortlist();
            
            // ìˆœìœ„ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
            initRankList();
            
            // Sortable.js ì´ˆê¸°í™”
            initSortable();
            
            // ê¸°ì¡´ ìˆœìœ„ ë¡œë“œ
            loadRankings();
        }

        // Step 1 í‘œì‹œ
        function showStep1() {
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step1').classList.remove('hidden');
            renderCards();
        }

        // Shortlist ì¹´ë“œí•¨ ë Œë”ë§
        function renderShortlist() {
            const container = document.getElementById('shortlistContainer');
            container.innerHTML = '';

            if (shortlist.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8">ë‹´ì€ íŒ€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            shortlist.forEach(participantId => {
                const participant = allParticipants.find(p => p.id === participantId);
                if (!participant) return;

                const card = createShortlistCard(participant);
                container.appendChild(card);
            });
        }

        // Shortlist ì¹´ë“œ ìƒì„±
        function createShortlistCard(participant) {
            const card = document.createElement('div');
            card.className = 'bg-gray-50 rounded-lg p-4 cursor-move border border-gray-200 hover:border-blue-500 transition';
            card.draggable = true;
            card.dataset.participantId = participant.id;

            const initials = (participant.company || participant.name || '?')
                .substring(0, 2)
                .toUpperCase();

            card.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold">
                        ${initials}
                    </div>
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-900">${participant.company || '-'}</h3>
                        <p class="text-sm text-gray-600">${participant.name || '-'}</p>
                    </div>
                    <button 
                        onclick="removeFromShortlist(${participant.id})" 
                        class="text-gray-400 hover:text-red-500 transition"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `;

            return card;
        }

        // ìˆœìœ„ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
        function initRankList() {
            rankings = {};
            const rankSlots = document.querySelectorAll('.rank-slot');
            rankSlots.forEach(slot => {
                const rankItem = slot.querySelector('.rank-item');
                rankItem.innerHTML = 'ë¹„ì–´ìˆìŒ';
                rankItem.className = 'min-h-[80px] border-2 border-dashed border-gray-300 rounded-lg p-4 flex items-center justify-center text-gray-400 rank-item';
                rankItem.dataset.participantId = '';
            });
        }

        // Sortable.js ì´ˆê¸°í™”
        function initSortable() {
            // Shortlist ì»¨í…Œì´ë„ˆ
            const shortlistContainer = document.getElementById('shortlistContainer');
            if (sortableShortlist) {
                sortableShortlist.destroy();
            }
            sortableShortlist = Sortable.create(shortlistContainer, {
                group: {
                    name: 'ranks',
                    pull: 'clone',
                    put: false
                },
                sort: false,
                animation: 150
            });

            // ê° ìˆœìœ„ ìŠ¬ë¡¯ì— Sortable ì ìš©
            document.querySelectorAll('.rank-slot').forEach(slot => {
                const rankItem = slot.querySelector('.rank-item');
                const rank = parseInt(slot.dataset.rank);
                
                // ê¸°ì¡´ Sortable ì¸ìŠ¤í„´ìŠ¤ ì œê±°
                if (rankItem.sortableInstance) {
                    rankItem.sortableInstance.destroy();
                }
                
                rankItem.sortableInstance = Sortable.create(rankItem, {
                    group: 'ranks',
                    animation: 150,
                    onAdd: function(evt) {
                        const participantId = parseInt(evt.item.dataset.participantId);
                        
                        // ê¸°ì¡´ ìˆœìœ„ì— ê°™ì€ ì°¸ê°€ìê°€ ìˆìœ¼ë©´ ì œê±°
                        Object.keys(rankings).forEach(r => {
                            if (rankings[r] === participantId) {
                                delete rankings[r];
                                updateRankSlot(parseInt(r));
                            }
                        });

                        rankings[rank] = participantId;
                        updateRankSlot(rank);
                        updateSubmitButton();
                        
                        // í´ë¡ ëœ ìš”ì†Œ ì œê±°
                        if (evt.item.parentElement !== rankItem) {
                            evt.item.remove();
                        }
                    },
                    onRemove: function(evt) {
                        const participantId = parseInt(evt.item.dataset.participantId);
                        if (rankings[rank] === participantId) {
                            delete rankings[rank];
                            updateRankSlot(rank);
                            updateSubmitButton();
                        }
                    }
                });
            });
        }

        // ìˆœìœ„ ìŠ¬ë¡¯ ì—…ë°ì´íŠ¸
        function updateRankSlot(rank) {
            const slot = document.querySelector(`.rank-slot[data-rank="${rank}"]`);
            if (!slot) return;

            const rankItem = slot.querySelector('.rank-item');
            const participantId = rankings[rank];

            if (participantId) {
                const participant = allParticipants.find(p => p.id === participantId);
                if (participant) {
                    const initials = (participant.company || participant.name || '?')
                        .substring(0, 2)
                        .toUpperCase();
                    
                    rankItem.innerHTML = `
                        <div class="flex items-center justify-between w-full">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold text-sm">
                                    ${initials}
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900">${participant.company || '-'}</h4>
                                    <p class="text-sm text-gray-600">${participant.name || '-'}</p>
                                </div>
                            </div>
                            <button 
                                onclick="removeFromRank(${rank})" 
                                class="text-gray-400 hover:text-red-500 transition"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    `;
                    rankItem.className = 'min-h-[80px] border-2 border-blue-500 rounded-lg p-4 bg-blue-50 rank-item';
                    rankItem.dataset.participantId = participantId;
                }
            } else {
                rankItem.innerHTML = 'ë¹„ì–´ìˆìŒ';
                rankItem.className = 'min-h-[80px] border-2 border-dashed border-gray-300 rounded-lg p-4 flex items-center justify-center text-gray-400 rank-item';
                rankItem.dataset.participantId = '';
            }
        }

        // ìˆœìœ„ì—ì„œ ì œê±°
        function removeFromRank(rank) {
            delete rankings[rank];
            updateRankSlot(rank);
            renderShortlist();
            initSortable();
            updateSubmitButton();
        }

        // Shortlistì—ì„œ ì œê±°
        function removeFromShortlist(participantId) {
            const index = shortlist.indexOf(participantId);
            if (index > -1) {
                shortlist.splice(index, 1);
                saveShortlist();
            }
            
            // ìˆœìœ„ì—ì„œë„ ì œê±°
            Object.keys(rankings).forEach(rank => {
                if (rankings[rank] === participantId) {
                    delete rankings[rank];
                    updateRankSlot(parseInt(rank));
                }
            });
            
            renderShortlist();
            initSortable();
            updateSubmitButton();
        }

        // ìˆœìœ„ ì €ì¥ (localStorage)
        function saveRankings() {
            const data = {
                rankings: rankings,
                noneFlag: document.getElementById('noneFlag').checked
            };
            localStorage.setItem(`rankings_${eventId}_${token}`, JSON.stringify(data));
        }

        // ìˆœìœ„ ë¡œë“œ (localStorage)
        function loadRankings() {
            const stored = localStorage.getItem(`rankings_${eventId}_${token}`);
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    rankings = data.rankings || {};
                    document.getElementById('noneFlag').checked = data.noneFlag || false;
                    
                    // ìˆœìœ„ ìŠ¬ë¡¯ ì—…ë°ì´íŠ¸
                    Object.keys(rankings).forEach(rank => {
                        updateRankSlot(parseInt(rank));
                    });
                    
                    updateSubmitButton();
                } catch (e) {
                    console.error('ìˆœìœ„ ë¡œë“œ ì˜¤ë¥˜:', e);
                }
            }
        }

        // ì œì¶œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateSubmitButton() {
            const noneFlag = document.getElementById('noneFlag').checked;
            const hasRank1 = rankings[1] !== undefined;
            const submitBtn = document.getElementById('submitBtn');
            
            submitBtn.disabled = !noneFlag && !hasRank1;
        }

        // ëª¨ë“  ìˆœìœ„ ë¹„ìš°ê¸°
        function clearAllRanks() {
            rankings = {};
            document.querySelectorAll('.rank-slot').forEach(slot => {
                const rank = parseInt(slot.dataset.rank);
                updateRankSlot(rank);
            });
        }

        // ìˆœìœ„ ì œì¶œ
        async function submitRankings() {
            const noneFlag = document.getElementById('noneFlag').checked;
            const submitBtn = document.getElementById('submitBtn');
            
            if (!noneFlag && !rankings[1]) {
                showNotification('1ìˆœìœ„ë¥¼ ì„ íƒí•˜ê±°ë‚˜ "ë§Œë‚˜ê³  ì‹¶ì€ íŒ€ ì—†ìŒ"ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ì œì¶œ ì „ ë°±ì—… ì €ì¥
            const backupData = {
                rankings: {...rankings},
                noneFlag: noneFlag,
                timestamp: Date.now()
            };
            localStorage.setItem(`backup_rankings_${eventId}_${token}`, JSON.stringify(backupData));

            // ì œì¶œ ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© í‘œì‹œ
            submitBtn.disabled = true;
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'ì œì¶œ ì¤‘...';

            try {
                const response = await fetch(`/api/events/${eventId}/preferences?token=${encodeURIComponent(token)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        rankings: noneFlag ? {} : rankings,
                        special_flag: noneFlag ? 'NONE' : null
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    // ì—ëŸ¬ ì‘ë‹µ ì²˜ë¦¬
                    const errorMessage = data.error || 'ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                    const errorDetails = data.details ? `\nìƒì„¸: ${data.details}` : '';
                    
                    // ë°±ì—… ë°ì´í„° ë³µì› ì˜µì…˜ ì œê³µ
                    const shouldRestore = confirm(
                        `ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n${errorMessage}${errorDetails}\n\në°±ì—… ë°ì´í„°ë¥¼ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
                    );
                    
                    if (shouldRestore) {
                        restoreFromBackup();
                    }
                    
                    throw new Error(errorMessage);
                }

                // ì„±ê³µ ì‹œ ë°±ì—… ë°ì´í„° ì‚­ì œ
                localStorage.removeItem(`backup_rankings_${eventId}_${token}`);
                
                // ì œì¶œ ì™„ë£Œ í™”ë©´ í‘œì‹œ
                showSubmitComplete();
            } catch (error) {
                console.error('ì œì¶œ ì˜¤ë¥˜:', error);
                showNotification('ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                
                // ì œì¶œ ë²„íŠ¼ ë³µì›
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        // ë°±ì—… ë°ì´í„° ë³µì›
        function restoreFromBackup() {
            const backup = localStorage.getItem(`backup_rankings_${eventId}_${token}`);
            if (backup) {
                try {
                    const data = JSON.parse(backup);
                    rankings = data.rankings || {};
                    document.getElementById('noneFlag').checked = data.noneFlag || false;
                    
                    // ìˆœìœ„ ìŠ¬ë¡¯ ì—…ë°ì´íŠ¸
                    Object.keys(rankings).forEach(rank => {
                        updateRankSlot(parseInt(rank));
                    });
                    
                    // Sortable ì¸ìŠ¤í„´ìŠ¤ ì¬ì´ˆê¸°í™”
                    initSortable();
                    
                    updateSubmitButton();
                    showNotification('ë°±ì—… ë°ì´í„°ê°€ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                } catch (e) {
                    console.error('ë°±ì—… ë³µì› ì˜¤ë¥˜:', e);
                    showNotification('ë°±ì—… ë°ì´í„° ë³µì›ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }
        }

        // ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
        function showNotification(message, type = 'info') {
            // ê¸°ì¡´ ì•Œë¦¼ ì œê±°
            const existing = document.getElementById('notification');
            if (existing) {
                existing.remove();
            }

            const notification = document.createElement('div');
            notification.id = 'notification';
            const bgColor = type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500';
            notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-4 rounded-lg shadow-lg z-50 max-w-md`;
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // 5ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // ì œì¶œ ì™„ë£Œ í™”ë©´
        function showSubmitComplete() {
            document.getElementById('step2').innerHTML = `
                <div class="text-center py-20">
                    <div class="text-6xl mb-4">ğŸ‰</div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-4">ì œì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤</h2>
                    <p class="text-gray-600 mb-8">ë§ˆê° ì „ê¹Œì§€ ì–¸ì œë“  ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                    <div class="flex gap-4 justify-center">
                        <button 
                            onclick="showStep2()" 
                            class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition"
                        >
                            ë‹¤ì‹œ ë³´ê¸°
                        </button>
                        <button 
                            onclick="window.close()" 
                            class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                        >
                            ë‹«ê¸°
                        </button>
                    </div>
                </div>
            `;
        }

        // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
        window.toggleShortlist = toggleShortlist;
        window.showCardDetail = showCardDetail;
        window.removeFromRank = removeFromRank;
        window.removeFromShortlist = removeFromShortlist;

        // ì¬í™•ì¸ ëª¨ë‹¬ í‘œì‹œ
        function showConfirmModal() {
            if (!participantData) return;

            confirmName.textContent = participantData.name || '-';
            confirmCompany.textContent = participantData.company || '-';
            confirmModal.style.display = 'flex';
        }

        // ëª¨ë‹¬ í™•ì¸ ë²„íŠ¼
        confirmOk.addEventListener('click', () => {
            confirmModal.style.display = 'none';
            if (confirmTimer) {
                clearTimeout(confirmTimer);
                confirmTimer = null;
            }
        });

        // ëª¨ë‹¬ ì·¨ì†Œ ë²„íŠ¼
        confirmCancel.addEventListener('click', () => {
            confirmModal.style.display = 'none';
            if (confirmTimer) {
                clearTimeout(confirmTimer);
                confirmTimer = null;
            }
        });

        // ì—ëŸ¬ í‘œì‹œ
        function showError(message) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        loadParticipantData();
    </script>
</body>
</html>

